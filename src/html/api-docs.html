<!DOCTYPE html>
<html>
    <head>
        <title>xrit-rx API Documentation</title>

        <!-- Preconnect to Google Fonts for faster loading -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        
        <!-- Load fonts asynchronously to prevent blocking -->
        <link href='https://fonts.googleapis.com/css?family=Roboto&display=swap' rel='stylesheet' media="print" onload="this.media='all'">
        <noscript><link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet'></noscript>
        
        <!-- Local CSS loads first -->
        <link rel="stylesheet" href="css/dash.css" />

        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <!-- Fallback fonts style for immediate rendering -->
        <style>
            body { 
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; 
            }
            /* Performance optimizations */
            .api-endpoint { contain: layout; }
            .image-type { contain: layout; }
            /* Reduce paint operations */
            #container { will-change: auto; }
            /* Optimize font rendering */
            body { 
                -webkit-font-smoothing: antialiased; 
                -moz-osx-font-smoothing: grayscale; 
                text-rendering: optimizeSpeed;
            }
        </style>
    </head>

    <body>
        <h2 id="dash-heading">
            xrit-rx API Documentation
            <span>
                <a href="/" style="color: #777; text-decoration: none; margin-right: 20px;">← Back to Dashboard</a>
                xrit-rx <a href="https://github.com/Zalgar/xrit-rx-docker" target="_blank" title="xrit-rx on GitHub">GitHub</a>
            </span>
        </h2>

        <div id="container">
            <div class="block" id="block-api-full">
                <div class="block-heading">API Documentation</div>
                <div class="block-body">
                    <h3>Available Endpoints</h3>
                    
                    <h4>System Information</h4>
                    <div class="api-endpoint">
                        <code>GET /api</code>
                        <p>Returns system configuration and status information including spacecraft, downlink type, output paths, and enabled features.</p>
                    </div>

                    <div class="api-endpoint">
                        <code>GET /api/docs</code>
                        <p>Returns comprehensive API documentation in JSON format with endpoint descriptions and example usage.</p>
                    </div>

                    <h4>Current Status</h4>
                    <div class="api-endpoint">
                        <code>GET /api/current/vcid</code>
                        <p>Returns the currently processing Virtual Channel ID (VCID). Useful for monitoring which data stream is active.</p>
                    </div>

                    <div class="api-endpoint">
                        <code>GET /api/current/progress</code>
                        <p>Returns real-time download progress for all active multi-segment products. Includes segment counts, progress percentages, and channel-specific details.</p>
                    </div>

                    <div class="api-endpoint">
                        <code>GET /api/current/partial</code>
                        <p>Returns information about available partial/preview images for active downloads. Shows which products have partial images ready for viewing.</p>
                    </div>

                    <h4>Latest Images</h4>
                    <div class="api-endpoint">
                        <code>GET /api/latest/image</code>
                        <p>Returns metadata for the most recent completed image of any type, including file path, hash, and image type.</p>
                    </div>
                    
                    <div class="api-endpoint">
                        <code>GET /api/latest/{type}</code>
                        <p>Returns metadata for the most recent completed image of a specific type (e.g., FD, SICEF24, etc.).</p>
                        <small>Replace {type} with one of the image types listed below (case-insensitive)</small>
                    </div>

                    <div class="api-endpoint">
                        <code>GET /api/latest/{type}/image</code>
                        <p>Returns the actual completed image file for the most recent image of a specific type. Content-Type header is set appropriately.</p>
                    </div>

                    <div class="api-endpoint">
                        <code>GET /api/latest/{type}/partial</code>
                        <p>Returns partial/preview image file for actively downloading products. Shows segments received so far with black areas for missing segments. Updated in real-time as new segments arrive.</p>
                    </div>

                    <h4>xRIT Files</h4>
                    <div class="api-endpoint">
                        <code>GET /api/latest/xrit</code>
                        <p>Returns metadata for the most recent xRIT file processed, including file path and processing information.</p>
                    </div>

                    <h4>Timelapse APIs</h4>
                    <p>Automated timelapse generation and access APIs. Timelapses are generated automatically every 30 minutes using the latest received images and stored in the timelapses/ directory.</p>
                    
                    <div class="api-endpoint">
                        <code>GET /api/timelapses/</code>
                        <p><strong>List Available Timelapses:</strong> Returns JSON list of all available timelapse files with metadata including file size, creation time, and download URLs.</p>
                    </div>

                    <div class="api-endpoint">
                        <code>GET /api/timelapses/{filename}</code>
                        <p><strong>Direct Timelapse Access:</strong> Download timelapse videos directly from the timelapses directory.</p>
                        <ul>
                            <li><strong>latest_3h_mp4.mp4</strong>: 3-hour MP4 timelapse</li>
                            <li><strong>latest_24h_mp4.mp4</strong>: 24-hour MP4 timelapse</li>
                            <li><strong>latest_3h_gif.gif</strong>: 3-hour GIF timelapse</li>
                            <li><strong>latest_24h_gif.gif</strong>: 24-hour GIF timelapse</li>
                        </ul>
                        <small>Example: <code>/api/timelapses/latest_3h_mp4.mp4</code></small>
                    </div>

                    <div class="api-endpoint">
                        <code>GET /api/timelapse/list</code>
                        <p><strong>Legacy Endpoint:</strong> Returns JSON list of all available timelapse files with metadata. Same functionality as <code>/api/timelapses/</code>.</p>
                    </div>

                    <h4>Timelapse Specifications</h4>
                    <div class="image-types">
                        <div class="image-type"><strong>3-Hour Timelapses:</strong> ~18 images (GK-2A transmits every 10 minutes)</div>
                        <div class="image-type"><strong>24-Hour Timelapses:</strong> ~144 images (6 per hour × 24 hours)</div>
                        <div class="image-type"><strong>MP4 Format:</strong> H.264 codec, 5fps, optimized for web playback</div>
                        <div class="image-type"><strong>GIF Format:</strong> Palette-optimized, 5fps, web-compatible animated GIF</div>
                        <div class="image-type"><strong>Resolution:</strong> 640px width (maintains aspect ratio)</div>
                        <div class="image-type"><strong>Generation:</strong> Automated every 30 minutes via background service</div>
                    </div>

                    <h4>Timelapse API Requirements</h4>
                    <ul>
                        <li><strong>FFmpeg:</strong> Required for video generation (included in Docker image)</li>
                        <li><strong>Image Directory:</strong> Must have received FD images in chronological order</li>
                        <li><strong>Background Service:</strong> Timelapse service must be running for automated generation</li>
                        <li><strong>Disk Space:</strong> Allow ~50-100MB per timelapse file depending on format and duration</li>
                        <li><strong>Processing Time:</strong> 30-60 seconds for generation depending on image count and format</li>
                    </ul>

                    <h4>Supported Image Types</h4>
                    <p>GK-2A LRIT data stream image types:</p>
                    <div class="image-types">
                        <div class="image-type"><strong>FD</strong> - Full Disk imagery</div>
                        <div class="image-type"><strong>SICEF24</strong> - Sea Ice and Cloud Edge Forecast (24h)</div>
                        <div class="image-type"><strong>SICEF48</strong> - Sea Ice and Cloud Edge Forecast (48h)</div>
                        <div class="image-type"><strong>SSTF24</strong> - Sea Surface Temperature Forecast (24h)</div>
                        <div class="image-type"><strong>SSTF48</strong> - Sea Surface Temperature Forecast (48h)</div>
                        <div class="image-type"><strong>SSTF72</strong> - Sea Surface Temperature Forecast (72h)</div>
                        <div class="image-type"><strong>FOGVIS</strong> - Fog Visibility forecast</div>
                        <div class="image-type"><strong>COMSFOG</strong> - Communication Satellite Fog imagery</div>
                        <div class="image-type"><strong>FCT</strong> - Forecast data products</div>
                        <div class="image-type"><strong>GWW3F</strong> - Global Wave Watch III Forecast</div>
                        <div class="image-type"><strong>RWW3A</strong> - Regional Wave Watch III Analysis</div>
                        <div class="image-type"><strong>SUFA03</strong> - Surface Analysis (3h intervals)</div>
                        <div class="image-type"><strong>ANT</strong> - Alphanumeric Text (schedules)</div>
                        <div class="image-type"><strong>ADD</strong> - Additional data products</div>
                    </div>

                    <h4>Response Formats</h4>
                    <p><strong>JSON Endpoints:</strong> Most endpoints return JSON with appropriate content-type headers.</p>
                    <p><strong>Image Endpoints:</strong> Image file endpoints return raw binary data with MIME types like image/jpeg, image/png, etc.</p>
                    <p><strong>Error Responses:</strong> Failed requests return JSON with error messages and appropriate HTTP status codes.</p>

                    <h4>Download Progress Features</h4>
                    <ul>
                        <li><strong>Segment Tracking:</strong> Monitor multi-part image segments</li>
                        <li><strong>Progress Percentage:</strong> Real-time completion status</li>
                        <li><strong>Partial Previews:</strong> Live image previews during download</li>
                        <li><strong>Timeout Handling:</strong> Auto-completion for incomplete downloads</li>
                        <li><strong>Real-time Updates:</strong> Dashboard auto-refresh</li>
                    </ul>

                    <h4>Example Usage</h4>
                    
                    <h5>Basic API Calls</h5>
                    <div class="api-endpoint">
                        <code>curl http://localhost:1692/api</code>
                        <p>Get system configuration and status information</p>
                    </div>

                    <div class="api-endpoint">
                        <code>curl http://localhost:1692/api/latest/fd</code>
                        <p>Get metadata for the latest Full Disk image</p>
                    </div>

                    <div class="api-endpoint">
                        <code>curl http://localhost:1692/api/latest/fd/image --output latest_fd.jpg</code>
                        <p>Download the latest completed Full Disk image file</p>
                    </div>

                    <div class="api-endpoint">
                        <code>curl http://localhost:1692/api/latest/fd/partial --output partial_fd.jpg</code>
                        <p>Download partial/preview image of currently downloading Full Disk image</p>
                    </div>

                    <h5>Progress Monitoring</h5>
                    <div class="api-endpoint">
                        <code>curl http://localhost:1692/api/current/progress</code>
                        <p>Get real-time download progress for active multi-segment products</p>
                    </div>

                    <div class="api-endpoint">
                        <code>curl http://localhost:1692/api/current/vcid</code>
                        <p>Check which Virtual Channel ID is currently being processed</p>
                    </div>

                    <h5>Timelapse Operations</h5>
                    <div class="api-endpoint">
                        <code>curl http://localhost:1692/api/timelapses/latest_3h_mp4.mp4 --output timelapse_3h.mp4</code>
                        <p>Download the latest 3-hour MP4 timelapse</p>
                    </div>

                    <div class="api-endpoint">
                        <code>curl http://localhost:1692/api/timelapses/latest_24h_gif.gif --output timelapse_24h.gif</code>
                        <p>Download the latest 24-hour GIF timelapse</p>
                    </div>

                    <div class="api-endpoint">
                        <code>curl http://localhost:1692/api/timelapses/</code>
                        <p>List all available timelapse files with metadata</p>
                    </div>
                    <h4>HTTP Status Codes</h4>
                    <ul>
                        <li><strong>200 OK</strong> - Request successful, data returned</li>
                        <li><strong>404 Not Found</strong> - Resource not available or doesn't exist (image/timelapse not ready)</li>
                        <li><strong>500 Internal Server Error</strong> - Server error occurred during processing</li>
                    </ul>

                    <h4>Timelapse Response Examples</h4>
                    <div class="api-endpoint">
                        <strong>List Response (/api/timelapses/):</strong>
                        <pre><code>{
  "timelapses": [
    {
      "filename": "latest_24h_mp4.mp4",
      "size": 5242880,
      "created": 1737936000,
      "url": "/api/timelapses/latest_24h_mp4.mp4"
    },
    {
      "filename": "latest_3h_gif.gif",
      "size": 1048576,
      "created": 1737939600,
      "url": "/api/timelapses/latest_3h_gif.gif"
    }
  ]
}</code></pre>
                    </div>

                    <div class="api-endpoint">
                        <strong>Error Response (file not found):</strong>
                        <pre><code>{
  "error": "Timelapse file not found"
}</code></pre>
                    </div>

                    <div class="api-endpoint">
                        <strong>List Response (legacy /api/timelapse/list):</strong>
                        <pre><code>{
  "timelapses": [
    {
      "filename": "latest_3h_mp4.mp4",
      "size": 2547832,
      "created": 1723362000,
      "url": "/api/timelapses/latest_3h_mp4.mp4"
    }
  ]
}</code></pre>
                    </div>

                    <h4>CORS and Cross-Domain Access</h4>
                    <p>CORS enabled for cross-domain API access and external monitoring dashboards.</p>

                    <h4>Rate Limiting and Performance</h4>
                    <ul>
                        <li>No rate limiting - designed for real-time monitoring</li>
                        <li>Progress updates every few seconds</li>
                        <li>Images served directly from disk</li>
                        <li>Partial images regenerated only when new segments arrive</li>
                    </ul>

                    <h4>Integration Notes</h4>
                    <p><strong>Dashboard:</strong> Web UI uses these APIs for real-time monitoring and timelapse display.<br>
                    <strong>External Apps:</strong> Build custom monitoring solutions and timelapse galleries.<br>
                    <strong>Automation:</strong> Automated download monitoring, alerting, and timelapse archiving.<br>
                    <strong>Timelapse Automation:</strong> Background service generates timelapses automatically - no manual intervention required.<br>
                    <strong>Media Integration:</strong> Direct API access allows embedding timelapses in external websites and applications.</p>

                    <h4>Timelapse Technical Details</h4>
                    <ul>
                        <li><strong>File Naming:</strong> Standardized naming: <code>latest_{duration}_{format}.{ext}</code></li>
                        <li><strong>Overwrite Behavior:</strong> New timelapses replace previous ones with same parameters</li>
                        <li><strong>Concurrent Generation:</strong> Multiple timelapses can be generated simultaneously</li>
                        <li><strong>Error Handling:</strong> Failed generations logged, service continues with next scheduled run</li>
                        <li><strong>Performance:</strong> Symlink-based temporary file management for efficiency</li>
                        <li><strong>Quality:</strong> Two-pass GIF generation with optimized palette for best quality</li>
                    </ul>
                </div>
            </div>
        </div>
    </body>
</html>
